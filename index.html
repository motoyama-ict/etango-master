<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中学校英単語マスター</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=M+PLUS+Rounded+1c:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'M PLUS Rounded 1c', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .btn:active {
            transform: translateY(0px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .choice-btn.correct {
            animation: correct-animation 0.5s ease;
            background-color: #22c55e !important; /* Tailwind green-500 */
            color: white;
            border-color: #16a34a;
        }
        .choice-btn.incorrect {
            animation: incorrect-animation 0.5s ease;
            background-color: #ef4444 !important; /* Tailwind red-500 */
            color: white;
            border-color: #dc2626;
        }
        @keyframes correct-animation {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes incorrect-animation {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-10px); }
            40% { transform: translateX(10px); }
            60% { transform: translateX(-10px); }
            80% { translateX(10px); }
        }
        @keyframes modal-pop {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        .animate-modal-pop {
            animation: modal-pop 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app-container" class="max-w-md mx-auto min-h-screen bg-white shadow-lg flex flex-col">

        <!-- ===== ホーム画面 ===== -->
        <div id="home-screen" class="screen active p-6 flex-grow flex flex-col">
            <header class="text-center mb-8">
                <h1 class="text-3xl font-bold text-sky-600">英単語マスター</h1>
                <p class="text-slate-500 mt-1">中学英単語 1200</p>
            </header>
            <main class="flex-grow space-y-4 flex flex-col justify-center">
                <button onclick="startQuiz(1)" class="btn w-full text-lg font-bold text-white bg-sky-500 hover:bg-sky-600 p-4 rounded-xl shadow-md">
                    <span class="block">中学1年生レベル</span>
                    <span id="progress-1" class="text-sm font-normal text-sky-100"></span>
                </button>
                <button onclick="startQuiz(2)" class="btn w-full text-lg font-bold text-white bg-teal-500 hover:bg-teal-600 p-4 rounded-xl shadow-md">
                    <span class="block">中学2年生レベル</span>
                    <span id="progress-2" class="text-sm font-normal text-teal-100"></span>
                </button>
                <button onclick="startQuiz(3)" class="btn w-full text-lg font-bold text-white bg-amber-500 hover:bg-amber-600 p-4 rounded-xl shadow-md">
                    <span class="block">中学3年生レベル</span>
                     <span id="progress-3" class="text-sm font-normal text-amber-100"></span>
                </button>
                <button onclick="startQuiz('mistakes')" id="mistakes-btn" class="btn w-full text-lg font-bold text-white bg-rose-500 hover:bg-rose-600 p-4 rounded-xl shadow-md mt-6 disabled:bg-slate-400 disabled:cursor-not-allowed">
                    <span class="block">にがてBOXから出題</span>
                    <span id="mistake-count" class="text-sm font-normal text-rose-100">0語</span>
                </button>
            </main>
            <footer class="text-center text-xs text-slate-400 mt-8">
                <p>ユーザーID: <span id="user-id-display"></span></p>
            </footer>
        </div>

        <!-- ===== クイズ画面 ===== -->
        <div id="quiz-screen" class="screen p-6 flex-grow flex flex-col">
            <header class="flex justify-between items-center mb-6">
                <div class="text-lg font-bold">
                    <span id="current-q-num">1</span> / <span id="total-q-num">10</span>
                </div>
                <button onclick="showScreen('home-screen')" class="text-slate-500 hover:text-sky-600 font-bold py-2 px-4 rounded">ホームに戻る</button>
            </header>
            <main class="flex-grow flex flex-col justify-center items-center">
                <div id="question-card" class="w-full bg-slate-100 rounded-xl p-8 text-center mb-8 shadow">
                    <p id="question-word" class="text-5xl font-bold tracking-wider">Hello</p>
                </div>
                <div id="choices-container" class="w-full grid grid-cols-2 gap-4">
                    <!-- 選択肢ボタンはJSで生成 -->
                </div>
            </main>
        </div>

        <!-- ===== 結果画面 ===== -->
        <div id="result-screen" class="screen p-6 flex-grow flex flex-col justify-center text-center">
            <header>
                <h2 class="text-2xl font-bold mb-2">結果</h2>
                <p id="result-score" class="text-5xl font-bold text-sky-600 mb-4"></p>
                <p id="result-message" class="text-lg text-slate-600 min-h-[2.5em] flex items-center justify-center"></p>
            </header>
            <div id="mistakes-list-container" class="mt-8 text-left">
                <h3 class="font-bold text-center mb-2">間違えた単語</h3>
                <ul id="mistakes-list" class="bg-slate-100 rounded-lg p-4 max-h-48 overflow-y-auto">
                    <!-- 間違えた単語リストはJSで生成 -->
                </ul>
            </div>
            <footer class="mt-8 space-y-4">
                <button id="retry-btn" class="btn w-full text-lg font-bold text-white bg-sky-500 hover:bg-sky-600 p-4 rounded-xl shadow-md">もう一度挑戦</button>
                <button onclick="showScreen('home-screen')" class="btn w-full text-lg font-bold text-slate-700 bg-slate-200 hover:bg-slate-300 p-4 rounded-xl shadow-md">ホームに戻る</button>
            </footer>
        </div>
    </div>

    <!-- ===== 正誤フィードバック表示 ===== -->
    <div id="feedback-overlay" class="hidden fixed inset-0 bg-black bg-opacity-30 flex justify-center items-center z-40 pointer-events-none">
        <div id="feedback-message" class="text-8xl font-bold text-white" style="text-shadow: 3px 3px 6px rgba(0,0,0,0.7);"></div>
    </div>

    <!-- ===== 例文表示モーダル ===== -->
    <div id="example-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-xl relative animate-modal-pop">
            <button onclick="closeModal('example-modal')" class="absolute top-2 right-2 text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0-0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-xl font-bold text-sky-600 mb-4">先生からの例文<span id="example-word-title"></span></h3>
            <div id="example-content" class="space-y-4">
                <div id="example-text">
                    <p id="example-en" class="text-lg font-semibold"></p>
                    <p id="example-ja" class="text-slate-600 mt-1"></p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, getDocs, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 単語データ (一部抜粋) ---
        const allWords = [
            // 中1レベル (Level 1)
            { en: 'I', ja: '私は', level: 1, ex_en: 'I am a student.', ex_ja: '私は生徒です。' }, 
            { en: 'you', ja: 'あなたは', level: 1, ex_en: 'You are my friend.', ex_ja: 'あなたは私の友達です。' }, 
            { en: 'he', ja: '彼は', level: 1, ex_en: 'He plays soccer.', ex_ja: '彼はサッカーをします。' }, 
            { en: 'she', ja: '彼女は', level: 1, ex_en: 'She likes cats.', ex_ja: '彼女は猫が好きです。' }, 
            { en: 'it', ja: 'それは', level: 1, ex_en: 'It is a sunny day.', ex_ja: '今日は晴れです。' }, 
            { en: 'we', ja: '私たちは', level: 1, ex_en: 'We go to school.', ex_ja: '私たちは学校に行きます。' }, 
            { en: 'they', ja: '彼らは', level: 1, ex_en: 'They live in Tokyo.', ex_ja: '彼らは東京に住んでいます。' },
            { en: 'this', ja: 'これは', level: 1, ex_en: 'This is a pen.', ex_ja: 'これはペンです。' },
            { en: 'that', ja: 'あれは', level: 1, ex_en: 'That is my house.', ex_ja: 'あれは私の家です。' },
            { en: 'play', ja: '遊ぶ', level: 1, ex_en: 'I play the piano.', ex_ja: '私はピアノを弾きます。' }, 
            { en: 'like', ja: '好き', level: 1, ex_en: 'I like Japanese food.', ex_ja: '私は日本食が好きです。' }, 
            { en: 'have', ja: '持っている', level: 1, ex_en: 'I have a dog.', ex_ja: '私は犬を飼っています。' }, 
            { en: 'go', ja: '行く', level: 1, ex_en: 'I go to the library.', ex_ja: '私は図書館に行きます。' }, 
            { en: 'see', ja: '見る', level: 1, ex_en: 'I see a bird.', ex_ja: '鳥が見えます。' },
            { en: 'read', ja: '読む', level: 1, ex_en: 'I read a book every day.', ex_ja: '私は毎日、本を読みます。' },

            // 中2レベル (Level 2)
            { en: 'will', ja: '〜だろう', level: 2, ex_en: 'I will be a doctor.', ex_ja: '私は医者になるつもりです。' }, 
            { en: 'enjoy', ja: '楽しむ', level: 2, ex_en: 'Did you enjoy the party?', ex_ja: 'パーティーは楽しかった？' },
            { en: 'visit', ja: '訪れる', level: 2, ex_en: 'I want to visit Kyoto.', ex_ja: '私は京都を訪れたいです。' }, 
            { en: 'important', ja: '重要な', level: 2, ex_en: 'English is important for us.', ex_ja: '英語は私たちにとって重要です。' },
            { en: 'beautiful', ja: '美しい', level: 2, ex_en: 'This flower is beautiful.', ex_ja: 'この花は美しいです。' },

            // 中3レベル (Level 3)
            { en: 'experience', ja: '経験', level: 3, ex_en: 'It was a good experience.', ex_ja: 'それは良い経験でした。' },
            { en: 'environment', ja: '環境', level: 3, ex_en: 'We must protect the environment.', ex_ja: '私たちは環境を守らなければなりません。' },
            { en: 'culture', ja: '文化', level: 3, ex_en: 'I am interested in Japanese culture.', ex_ja: '私は日本の文化に興味があります。' },
            { en: 'peace', ja: '平和', level: 3, ex_en: 'We all hope for world peace.', ex_ja: '私たちは皆、世界の平和を望んでいます。' }
        ];

        // 足りない単語データを補完
        const dummyWords = [
            { en: 'am', ja: 'です', level: 1 }, { en: 'are', ja: 'です', level: 1 }, { en: 'is', ja: 'です', level: 1 }, { en: 'my', ja: '私の', level: 1 }, { en: 'your', ja: 'あなたの', level: 1 }, { en: 'his', ja: '彼の', level: 1 }, { en: 'her', ja: '彼女の', level: 1 }, { en: 'a', ja: '一つの', level: 1 }, { en: 'an', ja: '一つの', level: 1 }, { en: 'the', ja: 'その', level: 1 }, { en: 'not', ja: '〜ではない', level: 1 }, { en: 'what', ja: '何', level: 1 }, { en: 'who', ja: '誰', level: 1 }, { en: 'where', ja: 'どこ', level: 1 }, { en: 'when', ja: 'いつ', level: 1 }, { en: 'how', ja: 'どうやって', level: 1 }, { en: 'pen', ja: 'ペン', level: 1 }, { en: 'book', ja: '本', level: 1 }, { en: 'desk', ja: '机', level: 1 }, { en: 'bag', ja: 'かばん', level: 1 }, { en: 'note', ja: 'ノート', level: 1 }, { en: 'apple', ja: 'りんご', level: 1 }, { en: 'orange', ja: 'オレンジ', level: 1 }, { en: 'cat', ja: '猫', level: 1 }, { en: 'dog', ja: '犬', level: 1 }, { en: 'come', ja: '来る', level: 1 }, { en: 'make', ja: '作る', level: 1 }, { en: 'get', ja: '得る', level: 1 }, { en: 'write', ja: '書く', level: 1 }, { en: 'eat', ja: '食べる', level: 1 }, { en: 'drink', ja: '飲む', level: 1 }, { en: 'run', ja: '走る', level: 1 }, { en: 'walk', ja: '歩く', level: 1 }, { en: 'swim', ja: '泳ぐ', level: 1 }, { en: 'sing', ja: '歌う', level: 1 }, { en: 'dance', ja: '踊る', level: 1 },
            { en: 'be', ja: '〜になる', level: 2 }, { en: 'going', ja: 'つもり', level: 2 }, { en: 'to', ja: '〜すること', level: 2 }, { en: 'if', ja: 'もし〜なら', level: 2 }, { en: 'because', ja: 'なぜなら', level: 2 }, { en: 'when', ja: '〜するとき', level: 2 }, { en: 'that', ja: 'ということ', level: 2 }, { en: 'must', ja: '〜しなければならない', level: 2 }, { en: 'may', ja: '〜かもしれない', level: 2 }, { en: 'can', ja: '〜できる', level: 2 }, { en: 'stay', ja: '滞在する', level: 2 }, { en: 'help', ja: '助ける', level: 2 }, { en: 'try', ja: '試す', level: 2 }, { en: 'stop', ja: 'やめる', level: 2 }, { en: 'start', ja: '始める', level: 2 }, { en: 'finish', ja: '終える', level: 2 }, { en: 'begin', ja: '始まる', level: 2 }, { en: 'work', ja: '働く', level: 2 }, { en: 'study', ja: '勉強する', level: 2 }, { en: 'learn', ja: '学ぶ', level: 2 }, { en: 'teach', ja: '教える', level: 2 }, { en: 'ask', ja: '尋ねる', level: 2 }, { en: 'answer', ja: '答える', level: 2 }, { en: 'talk', ja: '話す', level: 2 }, { en: 'speak', ja: '話す', level: 2 }, { en: 'listen', ja: '聞く', level: 2 }, { en: 'hear', ja: '聞こえる', level: 2 }, { en: 'feel', ja: '感じる', level: 2 }, { en: 'look', ja: '見る', level: 2 }, { en: 'find', ja: '見つける', level: 2 }, { en: 'think', ja: '思う', level: 2 }, { en: 'know', ja: '知っている', level: 2 }, { en: 'understand', ja: '理解する', level: 2 }, { en: 'believe', ja: '信じる', level: 2 }, { en: 'hope', ja: '望む', level: 2 }, { en: 'want', ja: '欲しい', level: 2 }, { en: 'need', ja: '必要とする', level: 2 }, { en: 'famous', ja: '有名な', level: 2 }, { en: 'popular', ja: '人気のある', level: 2 }, { en: 'difficult', ja: '難しい', level: 2 },
            { en: 'have', ja: '〜したことがある', level: 3 }, { en: 'been', ja: '（beの過去分詞）', level: 3 }, { en: 'done', ja: '（doの過去分詞）', level: 3 }, { en: 'seen', ja: '（seeの過去分詞）', level: 3 }, { en: 'made', ja: '（makeの過去分詞）', level: 3 }, { en: 'taken', ja: '（takeの過去分詞）', level: 3 }, { en: 'written', ja: '（writeの過去分詞）', level: 3 }, { en: 'read', ja: '（readの過去分詞）', level: 3 }, { en: 'spoken', ja: '（speakの過去分詞）', level: 3 }, { en: 'known', ja: '（knowの過去分詞）', level: 3 }, { en: 'which', ja: 'どちら', level: 3 }, { en: 'whose', ja: '誰の', level: 3 }, { en: 'who', ja: '（関係代名詞）', level: 3 }, { en: 'that', ja: '（関係代名詞）', level: 3 }, { en: 'to', ja: '（〜するために）', level: 3 }, { en: 'for', ja: '〜にとって', level: 3 }, { en: 'of', ja: '〜の', level: 3 }, { en: 'by', ja: '〜によって', level: 3 }, { en: 'with', ja: '〜と一緒に', level: 3 }, { en: 'about', ja: '〜について', level: 3 }, { en: 'government', ja: '政府', level: 3 }, { en: 'tradition', ja: '伝統', level: 3 }, { en: 'history', ja: '歴史', level: 3 }, { en: 'future', ja: '未来', level: 3 }, { en: 'science', ja: '科学', level: 3 }, { en: 'technology', ja: '技術', level: 3 }, { en: 'information', ja: '情報', level: 3 }, { en: 'communication', ja: 'コミュニケーション', level: 3 }, { en: 'international', ja: '国際的な', level: 3 }, { en: 'global', ja: '地球規模の', level: 3 }, { en: 'local', ja: '地元の', level: 3 }, { en: 'society', ja: '社会', level: 3 }, { en: 'problem', ja: '問題', level: 3 }, { en: 'solution', ja: '解決策', level: 3 }, { en: 'effort', ja: '努力', level: 3 }, { en: 'result', ja: '結果', level: 3 }, { en: 'knowledge', ja: '知識', level: 3 }, { en: 'war', ja: '戦争', level: 3 }, { en: 'life', ja: '生命', level: 3 }, { en: 'human', ja: '人間', level: 3 }, { en: 'nature', ja: '自然', level: 3 }
        ];
        allWords.push(...dummyWords);

        // --- アプリケーションの状態管理 ---
        let currentQuiz = {
            words: [],
            currentWordIndex: 0,
            score: 0,
            mistakenWordsInQuiz: [],
            level: null
        };
        let mistakenWords = [];
        let db, auth, userId;

        // --- Firebase初期化 ---
        async function initializeFirebase() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId.substring(0, 8) + '...';
                    setupMistakesListener();
                    updateProgress();
                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed: ", error);
                    }
                }
            });
        }
        
        // --- 画面・モーダル制御 ---
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // --- クイズロジック ---
        window.startQuiz = function(level) {
            let wordsForQuiz = [];
            if (level === 'mistakes') {
                if (mistakenWords.length === 0) return;
                wordsForQuiz = allWords.filter(word => 
                    mistakenWords.some(mistake => mistake.en === word.en && mistake.ja === word.ja)
                );
            } else {
                wordsForQuiz = allWords.filter(w => w.level === level);
            }

            wordsForQuiz.sort(() => Math.random() - 0.5);
            
            const quizLength = Math.min(wordsForQuiz.length, 10);
            if(quizLength === 0) return;

            document.getElementById('result-score').textContent = '';
            document.getElementById('result-message').textContent = '';
            document.getElementById('mistakes-list').innerHTML = '';
            document.getElementById('mistakes-list-container').style.display = 'none';

            currentQuiz = {
                words: wordsForQuiz.slice(0, quizLength),
                currentWordIndex: 0,
                score: 0,
                mistakenWordsInQuiz: [],
                level: level
            };

            document.getElementById('total-q-num').textContent = quizLength;
            displayQuestion();
            showScreen('quiz-screen');
        };

        function displayQuestion() {
            if (currentQuiz.currentWordIndex >= currentQuiz.words.length) {
                showResult();
                return;
            }

            document.getElementById('current-q-num').textContent = currentQuiz.currentWordIndex + 1;
            const wordData = currentQuiz.words[currentQuiz.currentWordIndex];
            document.getElementById('question-word').textContent = wordData.en;

            const choicesContainer = document.getElementById('choices-container');
            choicesContainer.innerHTML = '';
            
            let choices = [wordData.ja];
            const dummyWords = allWords.filter(w => w.en !== wordData.en);
            dummyWords.sort(() => Math.random() - 0.5);
            for (let i = 0; choices.length < 4 && i < dummyWords.length; i++) {
                if (!choices.includes(dummyWords[i].ja)) {
                    choices.push(dummyWords[i].ja);
                }
            }
            while(choices.length < 4) choices.push(`ダミー${choices.length}`);

            choices.sort(() => Math.random() - 0.5);

            choices.forEach(choice => {
                const button = document.createElement('button');
                button.textContent = choice;
                button.classList.add('btn', 'choice-btn', 'w-full', 'text-lg', 'font-semibold', 'text-slate-700', 'bg-white', 'p-4', 'rounded-xl', 'border-2', 'border-slate-300', 'hover:bg-slate-100');
                button.onclick = () => checkAnswer(choice, wordData.ja);
                choicesContainer.appendChild(button);
            });
        }
        
        function checkAnswer(selectedChoice, correctChoice) {
            const buttons = document.querySelectorAll('.choice-btn');
            buttons.forEach(b => b.disabled = true);

            const feedbackOverlay = document.getElementById('feedback-overlay');
            const feedbackMessage = document.getElementById('feedback-message');
            
            if (selectedChoice === correctChoice) {
                currentQuiz.score++;
                feedbackMessage.textContent = '正解！';
                feedbackMessage.className = 'text-8xl font-bold text-green-400';
                if (currentQuiz.level === 'mistakes') {
                    removeMistake(currentQuiz.words[currentQuiz.currentWordIndex]);
                }
            } else {
                feedbackMessage.textContent = '残念...';
                feedbackMessage.className = 'text-8xl font-bold text-red-500';
                const mistakenWord = currentQuiz.words[currentQuiz.currentWordIndex];
                currentQuiz.mistakenWordsInQuiz.push(mistakenWord);
                addMistake(mistakenWord);
            }
            
            buttons.forEach(button => {
                if (button.textContent === correctChoice) button.classList.add('correct');
                else if (button.textContent === selectedChoice) button.classList.add('incorrect');
            });

            feedbackOverlay.classList.remove('hidden');

            setTimeout(() => {
                feedbackOverlay.classList.add('hidden');
                currentQuiz.currentWordIndex++;
                displayQuestion();
            }, 1200);
        }

        function showResult() {
            document.getElementById('result-score').textContent = `${currentQuiz.score} / ${currentQuiz.words.length}`;
            showEncouragementMessage(currentQuiz.score, currentQuiz.words.length);

            const mistakesList = document.getElementById('mistakes-list');
            mistakesList.innerHTML = '';
            if (currentQuiz.mistakenWordsInQuiz.length > 0) {
                document.getElementById('mistakes-list-container').style.display = 'block';
                currentQuiz.mistakenWordsInQuiz.forEach(word => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center p-2 border-b";

                    const wordInfo = document.createElement('div');
                    wordInfo.innerHTML = `<span class="font-bold">${word.en}</span> <span class="text-slate-600 ml-2">${word.ja}</span>`;

                    const exampleBtn = document.createElement('button');
                    exampleBtn.textContent = '例文';
                    exampleBtn.className = "btn text-xs font-bold text-white bg-indigo-500 hover:bg-indigo-600 px-3 py-1 rounded-full shadow";
                    exampleBtn.onclick = () => showExampleSentence(word);

                    li.appendChild(wordInfo);
                    li.appendChild(exampleBtn);
                    mistakesList.appendChild(li);
                });
            } else {
                 document.getElementById('mistakes-list-container').style.display = 'none';
            }
            
            document.getElementById('retry-btn').onclick = () => startQuiz(currentQuiz.level);
            showScreen('result-screen');
        }

        // --- 固定コンテンツ表示 ---
        function showExampleSentence(word) {
            openModal('example-modal');
            document.getElementById('example-word-title').textContent = ` - ${word.en}`;
            
            if (word.ex_en && word.ex_ja) {
                document.getElementById('example-en').textContent = word.ex_en;
                document.getElementById('example-ja').textContent = word.ex_ja;
            } else {
                document.getElementById('example-en').textContent = 'この単語の例文は準備中です。';
                document.getElementById('example-ja').textContent = '';
            }
        }
        
        function showEncouragementMessage(score, total) {
            const percentage = (score / total) * 100;
            let messages;

            if (percentage === 100) {
                messages = ['完璧！すごい！この調子で頑張ろう！', '満点おめでとう！自信を持って次に進もう！', 'パーフェクト！素晴らしい集中力だね！'];
            } else if (percentage >= 80) {
                messages = ['素晴らしい！あと少しで完璧だね！', '高得点！よく頑張ったね！', 'すごい！間違えたところだけ確認しておこう。'];
            } else if (percentage >= 50) {
                messages = ['ナイスチャレンジ！半分以上できたね！', 'よく頑張ったね。復習が力になるよ！', 'お疲れ様！続けることが一番大事だよ！'];
            } else {
                messages = ['お疲れ様！まずは参加したことが素晴らしい！', 'ナイスファイト！ここからがスタートだ！', '間違えた単語は宝物だよ。しっかり復習しよう！'];
            }
            
            const message = messages[Math.floor(Math.random() * messages.length)];
            document.getElementById('result-message').textContent = message;
        }

        // --- Firestoreとの連携 ---
        function getMistakesCollectionRef() {
            return collection(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', userId, 'mistakenWords');
        }

        async function addMistake(word) {
            if (!userId) return;
            // 例文データはDBに保存しない
            const { ex_en, ex_ja, ...wordToSave } = word;
            try { await setDoc(doc(getMistakesCollectionRef(), wordToSave.en), wordToSave); }
            catch (e) { console.error("Error adding document: ", e); }
        }

        async function removeMistake(word) {
            if (!userId) return;
            try { await deleteDoc(doc(getMistakesCollectionRef(), word.en)); }
            catch (e) { console.error("Error removing document: ", e); }
        }
        
        function setupMistakesListener() {
            if (!userId) return;
            onSnapshot(getMistakesCollectionRef(), (snapshot) => {
                mistakenWords = snapshot.docs.map(doc => doc.data());
                updateMistakeCount();
            });
        }
        
        function updateMistakeCount() {
            const count = mistakenWords.length;
            document.getElementById('mistake-count').textContent = `${count}語`;
            document.getElementById('mistakes-btn').disabled = (count === 0);
        }

        async function updateProgress() {
            if(!userId) return;
            try {
                const snapshot = await getDocs(getMistakesCollectionRef());
                const mistakenEnWords = new Set(snapshot.docs.map(doc => doc.id));
                for(let level = 1; level <=3; level++){
                    const levelWords = allWords.filter(w => w.level === level);
                    const learnedCount = levelWords.filter(w => !mistakenEnWords.has(w.en)).length;
                    document.getElementById(`progress-${level}`).textContent = `達成度: ${learnedCount} / ${levelWords.length}`;
                }
            } catch(e) { console.error("Error fetching progress: ", e); }
        }

        // --- 初期化処理 ---
        window.onload = () => {
            initializeFirebase();
            // グローバルスコープに関数を公開
            window.showScreen = showScreen;
            window.closeModal = closeModal;
        };
    </script>
</body>
</html>

